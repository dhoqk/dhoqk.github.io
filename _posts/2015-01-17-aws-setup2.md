---
layout: post
title: AWS EC2 setup with node.js Part 2
description: "Create EC2 instance and install node.js."
tags: [ec2, ec2 instance, setup, node.js, npm, AWS, EBS]
excerpt_separator: "<!-- more -->"
image:
  background: witewall_3.png
---

###Install Express data on EBS volume

<!--more-->
If you followed the general guidelines up to step 3 in the first section, you should've created, attached and mounted EBS volume on **/mnt/my-data**

We are going to follow guides from [Express](http://expressjs.com/starter/generator.html) website.  In terminal browse to directory you want your web application to be created.

For example the following will create `myapp`, web application skeleton, under **/mnt/my-data**.  If you want to install it under different directory change 

{% highlight bash %}
cd mnt/my-data
{% endhighlight %}

from belowe to anything you want.

In terminal:

{% highlight bash %}
cd /
cd mnt/my-data
sudo express myapp
{% endhighlight %}

Now install dependencies:

{% highlight bash %}
cd myapp && npm install
{% endhighlight %}

And run this to debug (not necessary):

{% highlight bash %}
DEBUG=myapp ./bin/www
{% endhighlight %}

Now let's create first app.
Open any text editor, copy and paste this code and save it as app.js.
{% highlight javascript %}
var express = require('express')
var app = express()

app.get('/', function (req, res) {
  res.send('Hello World!')
})

var server = app.listen(3000, function () {

  var host = server.address().address
  var port = server.address().port

  console.log('Example app listening at http://%s:%s', host, port)

})
{% endhighlight %}

###Open Port 3000 in AWS EC2

Before we go any further you should make sure port 3000 is open for EC2 instance.

1. Go to EC2 console and click on security groups.
2. Choose the security group you are using.
3. Click on Actions and Edit Inbound Rules.
4. From popup window click on Add rule.
5. From pull down menu, highlight Custom TCP Rule and change Port Range to 3000.
6. Source should be from anywhere.
7. Click Save.

##Open your FTP program or download Filezilla from [here](http://www.filezilla.com).##

1. Follow instructions [here](http://dhoqk.github.io/filezilla-configuration.md) to setup.
2. Once connected to your server via filezilla, browse to your directory 'myapp' (right-side window is your server).
3. From left-side window, browse to where you saved 'app.js' and copy it over to server directory 'myapp' by right clicking on file and uploading.

>When you are looking at the right-side of the window look at file name and 'permissions'.
>If you see all dashes like so ------- then we have to change permissions from SSH.
>Back to terminal, and type this:
>
>{% highlight ssh %}
>cd /
>sudo chmod -R 755 path_to_myapp
>#path_to_myapp should be something like "mnt/my-data/myapp"
>{% endhighlight %}
>Refresh Filezilla files (there's a littl icon at top) and make sure permissions for >app.js looks something like this
>-rwxr-xr-x-

###Test on browser and configure port fowarding

From your browser:

{% highlight bash %}
http://yourdomain.com:3000
{% endhighlight %}

You should get a response with "Hello World".  If you don't make sure you have opened port 3000 from EC2 instance and saved it.

Getting the response is all good and all, but you don't want your users to type ":3000" everytime they connect to your website.  We need port forwarding for that.

Open terminal again and type this:

{% highlight bash %}
#Press Control-C if myapp is still listening on port 3000 to return to command prompt
sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3000
{% endhighlight %}

This will successfully redirect the HTTP/HTTPS request, which is listening on port 80, to 3000.  Why do this instead of changing the code to listen to 80?  Because, you don't want your process to be running on root.  If hackers found out that your service is running on 80 they can cause mayhem to your server.  And Express/Node.JS will throw an exception if you try to use 80.  Well, at least, it did it to me.

Now, rerun your app from terminal.

{% highlight bash %}
sudo node myapp.js
{% endhighlight %}

Make sure it says it's listening on port 3000.
From your browser go to _yourdomain.com_.

You should again see "Hello World!".

